from scapy.all import *
import os

def packet_handler(packet):
    data = packet.load.decode(errors="ignore")

    if data.startswith("bob#"):
        parts = data.split("#", 6)
        if len(parts) < 7:
            print("Received wrong packet.")
            return
        content_hash = parts[1]
        lenomdufichier = parts[2]
        total_packets = int(parts[3])
        sequence_number = int(parts[4])
        lecontenu = parts[5]

        print("Message received : \n Title : " + lenomdufichier + "\nHash : " + content_hash + "\nTotal packets : " + str(total_packets) + "\nSequence number : " + str(sequence_number) + "\nContent : " + lecontenu)

        # Obtenir le chemin du répertoire du script
        script_dir = os.path.dirname(os.path.realpath(__file__))
        # Créer le chemin du fichier de contenu
        content_file_path = os.path.join(script_dir, content_hash)
        
        # Si le fichier de contenu n'existe pas déjà, le créer et écrire le contenu
        if not os.path.exists(content_file_path):
            print("Creating content file: " + content_file_path)
            with open(content_file_path, 'wb') as file:
                file.write(lecontenu.encode(errors="ignore"))
        
        # Créer le chemin du fichier de noms
        names_file_path = os.path.join(script_dir, content_hash + ".names")
        # Ajouter le nom du fichier au fichier de noms
        with open(names_file_path, 'a') as file:
            file.write(lenomdufichier + "\n")
    else:
        print("Received wrong packet.")

sniff(iface="lo", filter="icmp", prn=packet_handler)