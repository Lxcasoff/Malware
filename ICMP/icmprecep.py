from scapy.all import *
import os

base_path = "/home/chuisju/Documents/Cours/MS1/"


def packet_handler(packet):
    # Vérifier si le paquet contient des données
    if not hasattr(packet, 'load'):
        print("Received packet without data.")
        return

    data = packet.load.decode(errors="ignore")

    # Vérifier si les données du paquet sont correctement formatées
    if not data.startswith("bob#"):
        print("Received packet with wrong data format.")
        return

    parts = data.split("#", 6)
    
    if len(parts) < 6:
        print("Received packet with missing data.")
        
        return
    print(parts[5])
    content_hash = parts[1]
    lenomdufichier = parts[2]
    total_packets = int(parts[3])
    sequence_number = parts[4]
    lecontenu = parts[5]

    if(not os.path.isdir(base_path + "/tmp")):
        os.mkdir(base_path + "/tmp")
    if(not os.path.isdir(base_path + "/tmp/" + content_hash)):
        os.mkdir(base_path + "/tmp/" + content_hash)
    if(not os.path.isfile(base_path + "/tmp/" + content_hash + "/seq_" + sequence_number)):
        f = open(base_path + "/tmp/" + content_hash + "/seq_" + sequence_number, "w")
        f.write(lecontenu)
        f.close()
        i = 0
        for fi in os.listdir(base_path + "/tmp/" + content_hash):
            if(fi.startswith("seq_")):
                i += 1
        if(i == total_packets):
            print("Reconstruction du fichier")
            f = open(content_hash, "w")
            for j in range(1, len(os.listdir(base_path + "/tmp/" + content_hash)) + 1):
                _f = open(base_path + "/tmp/" + content_hash + "/seq_" + str(j), "r")
                f.write(_f.read())
                _f.close()
                os.remove(base_path + "/tmp/" + content_hash + "/seq_" + str(j))
            f.close()
            os.rmdir(base_path + "/tmp/" + content_hash)

        

# Démarrer la capture de paquets
sniff(filter="icmp", prn=packet_handler)